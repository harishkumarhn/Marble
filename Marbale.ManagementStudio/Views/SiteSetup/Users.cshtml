@{
    ViewBag.Title = "Users";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<style>
    table input {
        font-size: 13px;
    }

    table.marbleTable thead th, table.marbleTable thead td {
        padding-top: 0px !important;
        padding-bottom: 0px !important;
    }

    table.marbleTable tbody th, table.marbleTable tbody td {
        padding-top: 0px !important;
        padding-bottom: 0px !important;
    }
</style>
<table id="marbleTable" class="stripe row-border order-column marbleTable" style="width: 100%">
    <thead>
    <th>Id</th>
    <th>Edit</th>
    <th>Name</th>
    <th>Role</th>
    <th>Email</th>
    <th>LoginId</th>
    <th>Password</th>
    <th>Status</th>
    <th>POSCounter</th>
    <th>Department</th>
    <th>Manager</th>
    <th>CompanyAdmin</th>
    <th>EmpStartDate</th>
    <th>EmpEndDate</th>
    <th>EmpEndResone</th>
    <th>PasswordChangeDate</th>
    <th>Invalid Attempts</th>
    <th>LastLoginTime</th>
    <th>LastLogoutTime</th>
    <th>CreationDate</th>
    <th>CreatedBy</th>
    <th>LastUpdatedBy</th>
    <th>LastUpdatedDate</th>
    </thead>
    @foreach (var item in ViewBag.users)
    {
        <tr disableRow="@(item.ReadOnly == true ? "disable" : "enable")">
            <td>
                <lable class="fixedCol1">@(item.Id == 0 ? "" : item.Id) </lable>
            </td>
            <td>
                <a class="edit" title="Edit" data-toggle="tooltip" style="pointer-events: @(item.ReadOnly == true ? "none":"all")" onclick="EditUser('@item.Id')">
                    <i class="material-icons" style="cursor: pointer;">&#xE254;</i>
                </a>
                <a class="delete" title="Delete" data-toggle="tooltip" style="pointer-events: @(item.ReadOnly == true ? "none":"all")" onclick="DeleteUser('@item.Id','@item.ReadOnly')">
                    <i class="material-icons" style="cursor: pointer;">&#xE872;</i>
                </a>
            </td>
            <td>
                <input class="fixedCol2" type="text" value="@item.Name" style="width: 5vw;"/>
            </td>
            <td>
                <select name="Roles" id="Roles">
                    @foreach (var dow in item.Roles)
                    {
                        if (@item.RoleId == @dow.Id)
                        {
                            <option id="@dow.Id" value="@dow.Value" selected>@dow.Value</option>
                        }
                        else
                        {
                            <option id="@dow.Id" value="@dow.Value">@dow.Value</option>
                        }
                    }
                </select>
            </td>
            <td>
                <input type="text" value="@item.Email" />
            </td>
            <td>
                <input type="text" value="@item.LoginId" style="width: 5vw;"/>
            </td>
            <td>
                <input type="text" value="@item.Password" style="width: 6vw;"/>
            </td>
            <td>
                <select name="Statuses" id="Statuses">
                    @foreach (var dow in item.Statuses)
                    {
                        if (@item.Status == @dow.Value)
                        {
                            <option value="@dow.Value" selected>@dow.Value</option>
                        }
                        else
                        {
                            <option value="@dow.Value">@dow.Value</option>
                        }
                    }
                </select>
            </td>
            <td>
                <input type="text" value="@item.POSCounter" style="width: 7vw;"/>
            </td>
            <td>
                <input type="text" value="@item.Department" style="width: 7vw;"/>
            </td>
            <td>
                <input type="text" value="@item.Manager" style="width: 6vw;"/>
            </td>
            <td>
                <input type="checkbox" @(item.CompanyAdmin ? "checked='checked'" : "") value="@item.CompanyAdmin" />
            </td>
            <td>
                <input type="text" value="@item.EmpStartDate" style="width: 8vw;"/>
            </td>
            <td>
                <input type="text" value="@item.EmpEndDate" style="width: 8vw;"/>
            </td>
            <td>
                <input type="text" value="@item.EmpEndReason" style="width: 9vw;"/>
            </td>
            <td>
                <label>@item.PaswardChangeDate</label>
            </td>
            <td>
                <label>@item.InvalidAttempts</label>
            </td>
            <td>
                <label>@item.LastLoginTime</label>
            </td>
            <td>
                <label>@item.LastLogoutTime</label>
            </td>
            <td>
                <label>@item.CreationDate</label>
            </td>
            <td>
                <label>@item.CreatedBy</label>
            </td>
            <td>
                <label>@item.LastUpdatedBy</label>
            </td>
            <td>
                <label>@item.LastUpdatedDate</label>
            </td>
        </tr>
    }
</table>

<div class="action">

    <button class="btn btn-primary btn-md" role="button" onclick="SaveUsers()">Save</button>
    <button class="btn btn-primary btn-md" role="button" id="addRow">Add User</button>
    <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#basicExampleModal" onclick="EditUser()">
        New
    </button>
    <button class="btn btn-primary btn-md" role="button" onclick="event.preventDefault(); history.back();" id="back">Back</button>
    <button class="btn btn-primary btn-md" role="button" onclick="event.preventDefault(); window.location = '/Marble/Index'">Close</button>


</div>
<script>
    $(document).ready(function () {
        var table = $('#marbleTable').DataTable({
            scrollY: "400px",
            scrollX: true,
            scrollCollapse: true,
            editable: true,
            stateSave: true,
            // paging: true,
            bPaginate: false,
            bInfo: false,
            bFilter: false,
            bSort: false,
            "createdRow": function (row, data, index) {
                $('td', row).addClass('tblRow');
            },
            rowCallback: function (row, data) {
                var element = $('td', row);
                element.on("change", function (e) {
                    UpdatedList($(this).parent().index());
                });
            },
            //order: [[ 0, "desc" ]],
            fixedColumns: {
                leftColumns: 3
            }
        });
        $('#marbleTable tbody').on('click', 'tr', function () {
            if ($(this).hasClass('selected')) {
                $(this).removeClass('selected');
            }
            else {
                table.$('tr.selected').removeClass('selected');
                $(this).addClass('selected');
            }
        });
        $('#addRow').on('click', function () {
            var fixedcolumn1values = $('.DTFC_Cloned lable.fixedCol1');
            var fixedcolumn3values = $('.DTFC_Cloned input.fixedCol2');

            var rolesOptions = '';
            @foreach (var dow in ViewBag.users[0].Roles)
              {
                 @: rolesOptions = rolesOptions + '<option id="@dow.Id" value="" >@dow.Value</option>';
                          }
            rolesOptions = rolesOptions + '</select>';
            var statusListOptions = '';
            @foreach (var dow in ViewBag.users[0].Statuses)
              {
                 @: statusListOptions = statusListOptions + '<option id="@dow.Id" value="" >@dow.Value</option>';
                          }
            statusListOptions = statusListOptions + '</select>';
            table.row.add([
                '<lable class="fixedCol1"></lable>',
                '',
                '<input class="fixedCol2" type="text" value="" style="width: 5vw;"/>',
                '<select name="roles" id="roles">' + rolesOptions,
                '<input type="text" value="" />',
                '<input type="text" value="" style="width: 5vw;"/>',
                '<input type="text" value="" style="width: 6vw;"/>',
                '<select name="statuses" id="statuses">' + statusListOptions,
                '<input type="text" value="" style="width: 7vw;"/>',
                '<input type="text" value="" style="width: 7vw;"/>',
                '<input type="text" value="" style="width: 6vw;"/>',
                '<input type="checkbox" />',
                '<input type="text" value="" style="width: 8vw;"/>',
                '<input type="text" value="" style="width: 8vw;"/>',
                '<input type="text" value="" style="width: 9vw;"/>',
                '<label></label>',
                '<label></label>',
                '<label></label>',
                '<label></label>',
                '<label></label>',
                '<label></label>',
                '<label></label>',
                '<label></label>',
            ]).draw(false);

            for (var i = 0, j = fixedcolumn1values.length; i < j; i++) {
                $('.DTFC_Cloned lable.fixedCol1')[i].innerHTML = fixedcolumn1values[i].innerHTML;
            }
            for (var i = 0, j = fixedcolumn3values.length; i < j; i++) {
                $('.DTFC_Cloned input.fixedCol3')[i].value = fixedcolumn3values[i].value;
            }
        });
        $(".tblRow").on("change", function (e) { UpdatedList($(this).parent().index()); });

        var superUserElement = $('tr[disableRow="disable"]');
        superUserElement.find('input,select').prop('disabled', true);
    });

    function SaveUsers() {
        if (updatedArray.length > 0) {
            var items = [];
            var table = document.getElementById('marbleTable');
            var fixedcolumn1 = $('.DTFC_Cloned lable.fixedCol1');
            var fixedcolumn3 = $('.DTFC_Cloned input.fixedCol2');

            for (var r = 0, n = table.rows.length; r < n; r++) {
                if (updatedArray.includes(r)) {
                    var rowIndex = r + 1;
                    var selectedRoleIndex = table.rows[rowIndex].cells[3].children[0].options["selectedIndex"];
                    var selectedStatusIndex = table.rows[rowIndex].cells[7].children[0].options["selectedIndex"];
                    items.push({
                        Id: fixedcolumn1[r].innerHTML.trim() == '' ? -1 : fixedcolumn1[r].innerHTML,
                        Name: fixedcolumn3[r].value,
                        RoleId: table.rows[rowIndex].cells[3].children[0].options[selectedRoleIndex].id,
                        Email: table.rows[rowIndex].cells[4].children[0].value,
                        LoginId: table.rows[rowIndex].cells[5].children[0].value,
                        Password: table.rows[rowIndex].cells[6].children[0].value,
                        Status: table.rows[rowIndex].cells[7].children[0].options[selectedStatusIndex].innerText,
                        POSCounter: table.rows[rowIndex].cells[8].children[0].value,
                        Department: table.rows[rowIndex].cells[9].children[0].value,
                        Manager: table.rows[rowIndex].cells[10].children[0].value,
                        CompanyAdmin: table.rows[rowIndex].cells[11].children[0].checked,
                        EmpStartDate: table.rows[rowIndex].cells[12].children[0].value,
                        EmpEndDate: table.rows[rowIndex].cells[13].children[0].value,
                        EmpEnsReason: table.rows[rowIndex].cells[14].children[0].value
                    });
                }
            }
            $.ajax({
                type: "POST",
                contentType: "application/json; charset=utf-8",
                url: '@Url.Action("InsertOrUpdateUsers", "SiteSetup")',
                data: JSON.stringify({ users: items }),
                dataType: "json",
                success: function (returndata) {
                    if (returndata.ok) {
                        notify('success', 'Success Message', 'Data Saved Successfully');
                    }
                    else {
                        //this is an error from the server
                        notify('error', 'Error Message', returndata.message);
                    }

                }
            });
        }
    }
    var updatedArray = [];
    function UpdatedList(rowIndex) {
        if (!updatedArray.includes(rowIndex)) {
            updatedArray.push(rowIndex);
        }
    }
    function EditUser(id) {
        $('#myModal').modal('show');
        $('#modelBody').css({
            'left': '-40%',
            'width': 850
        });
        if (id != 0) {
            $('#modelBody').load('/SiteSetup/EditUser', { "id": id });
            $('.modal-title').text('Edit Product');
        } else {
            $('#modelbody').load('/SiteSetup/EditUser');
            $('.modal-title').text('New User');
        }
    }
    function DeleteUser(id) {
        if (confirm('Are you sure you want to delete this from database?')) {
            $.ajax({
                type: "GET",
                contentType: "application/json; charset=utf-8",
                url: '@Url.Action("DeleteUser", "SiteSetup")',
                data: { Id: id },
                dataType: "json",
                success: function (data) {
                    notify('delete', '', '', () => {
                        location.reload();
                    });
                },
                error: function (e) {
                    alert(e);
                }
            });
        }
    }
</script>
